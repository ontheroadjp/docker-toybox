#!/bin/sh

. $TOYBOX_HOME/core/list.fnc

# ----------------------------------------
# Global variables
# ----------------------------------------

project_name="toybox"
version="0.1.0"

applist="$TOYBOX_HOME/stack/applications.txt"
#compose_file="${app_path}/bin/docker-compose.yml"
#src="$TOYBOX_HOME/src/${app_name}"

fqdn=""
port=""
applist_grep_key=""
app_name=""
app_path=""
compose_file=""
src=""

timezone=$(date +%Z)

# ----------------------------------------
# Private Functions
# ----------------------------------------

function __usage() {
  cat <<-EOF
Usage: 
    ${project_name} [-s|-d] <application> new
    ${project_name} <URL> <command>
    ${project_name} <command>

option:
    -s              Assigning specific sub domain name(e.x: -s www) 
    -d              Assigning specific sub domain name(e.x: -d example.com)

application:
    proxy           Http dinamic proxy server based on nginx 
    php5            LAMP(Apache2.4 + MySQL5.6 + PHP5.6)
    php7            LAMP(Apache2.4 + MySQL5.6 + PHP7.0)
    wordpress       The most popular CMS
    owncloud        Personal cloud strage like Dropbox
    lychee          Photo management system
    reichat         Paint chat

command with URL:
    start           Start ${project_name} application
    stop            Stop ${project_name} application
    restart         Stop and Start ${project_name} application
    ps              Show ${project_name} application status
    ip              Show containers IP Address
    clear           Stop and Remove all of ${project_name} application

command:
    env             Show the environment variables
    version         Show the version of ${project_name}
    help            Show this message

EOF
}

function _env() {
    echo "TOYBOX_HOME: $TOYBOX_HOME"
    echo "TOYBOX_DOMAIN: $TOYBOX_DOMAIN"
    #echo "TOYBOX_LETSENCRYPT_HOST: $TOYBOX_LETSENCRYPT_HOST"
    #echo "TOYBOX_LETSENCRYPT_EMAIL: $TOYBOX_LETSENCRYPT_EMAIL"
}

function _version() { 
    echo ${version} 
}

function _help() { 
    __usage 
}

function __is_set_env() {
    env | grep $1 > /dev/null 2>&1;
}

function __is_executable() {
    local command="$1"
    type "${command}" > /dev/null 2>&1
}

function __is_exist_in_applist() {
    cat ${applist} | grep ${applist_grep_key} > /dev/null 2>&1
}


function __is_container_exist() {
    #$1 = ${app_name}
    docker ps -a | grep ${project_name}_${1}_ > /dev/null 2>&1
}

function __is_container_running() {
    #$1 = ${app_name}
    docker ps -a | grep ${project_name}_${1}_ | grep Up > /dev/null 2>&1
}

#function __applist() {
#    if [ -f ${applist} ]; then
#        cat ${applist} | awk 'BEGIN{ OFS=" " }
#            function red(s) { printf "\033[1;31m%s\033[0m",s }
#            function green(s) { printf "\033[1;32m%s\033[0m",s }
#            function blue(s) { printf "\033[1;34m%s\033[0m",s }
#            function app(s) { printf "%-15s",s }
#            function status(s) { 
#                if(s == "running")
#                    printf "\033[1;32m%s\033[0m",s
#                else if(s == "stopped")
#                    printf "\033[1;31m%s\033[0m",s
#                else
#                    printf "%s",s
#            }
#            { printf "%2s",NR } { printf ": http://%-35s",$1 }
#            { app($2) }
#            { status($3) }
#            { printf "\n" }'
#    else
#        echo 'no application available.'
#    fi
#}

function __print_header() {
    echo ''
    echo '  _____         ___          '
    echo ' |_   _|__ _  _| _ ) _____ __'
    echo '   | |/ _ \ || | _ \/ _ \ \ /'
    echo '   |_|\___/\_, |___/\___/_\_\'
    echo '           |__/  Nuts Project'
    echo ''
}

#function __list() {
#
#    __print_header
#
#    if [ ! -f ${applist} ]; then
#        echo 'no application available.'
#
#    else
#        app_name="proxy"
#        . $TOYBOX_HOME/lib/proxy.fnc
#        for container in ${containers[@]}; do
#            __is_container_exist ${container}; local exist=$(( ${exist} + $? ))
#            __is_container_running ${container}; local running=$(( ${running} + $? ))
#        done
#
#
#        if [ ${exist} -eq 0 ] && [ ${running} -eq 0 ]; then
#            printf "proxy is "
#            printf "\033[1;32m%-10s\033[0m" "running"
#        else
#            printf "you must start proxy"
#        fi
#        printf "\n"
#
#        cat ${applist} | while read line; do
#
#            fqdn=$(echo ${line} | awk '{print $1}')
#            applist_grep_key=${fqdn}
#            app_name=$(echo ${line} | awk '{print $2}')
#            app_path=$(echo ${line} | awk '{print $4}')
#            compose_file="${app_path}/bin/docker-compose.yml"
#            src="$TOYBOX_HOME/src/${app_name}"
#            . $TOYBOX_HOME/lib/${app_name}.fnc
#
#            if [ ${app_name} = 'proxy' ]; then
#                continue
#            else
#                printf "http://%-35s" ${fqdn}
#            fi
#
#            printf "%-15s" ${app_name}:${app_version}
#
#            local exist=0
#            local running=0
#
#            for container in ${containers[@]}; do
#                __is_container_exist ${container}; exist=$(( ${exist} + $? ))
#                __is_container_running ${container}; running=$(( ${running} + $? ))
#            done
#
#            if [ ${exist} -eq ${#containers[@]} ]; then
#                printf "%-10s" "removed"
#            elif [ ${exist} -eq 0 ] && [ ${running} -eq 0 ]; then
#                printf "\033[1;32m%-10s\033[0m" "running"
#            elif [ ${exist} -eq 0 ] && [ ${running} -eq ${#containers[@]} ]; then
#                printf "\033[1;31m%-10s\033[0m" "stopped"
#            else
#                printf "\033[1;31m%-10s\033[0m" "error"
#            fi
#            printf "\n"
#
#        done
#    fi
#}

# ----------------------------------------
# Command
# ----------------------------------------

function _containers() {
    source ~/.bash_profile > /dev/null 2>&1
    DD
}

function _new() {
    local exist=''
    if [ -f ${applist} ]; then
        if __is_exist_in_applist && [ ${app_name} = "proxy" ]; then
            echo "${project_name}: 'proxy #${port}' is already used."
            exit 1
        elif __is_exist_in_applist; then
            echo "${project_name}: 'http://${fqdn}' is already used."
            echo "Please try to 'new' command again with -d or -s option."
            exit 1
        fi
    else
        touch ${applist}
    fi

    __init && {
        cd ${app_path}/bin
        docker-compose -p ${project_name} up -d && {
            echo "---------------------------------"
            echo "URL: http://${fqdn}"
            echo "---------------------------------"

            if [ ${app_name} = 'proxy' ]; then
                new="${port} ${app_name} running #${port}"
            else
                new="${fqdn} ${app_name} running ${app_path}"
            fi
            echo ${new} >> ${applist}
        }
    }
}

function _start() {
    if [ ${app_name} = "proxy" ]; then
        __new

    elif [ ! -f ${applist} ]; then
        echo "${project_name}: 'http://${fqdn}' does not exist."
        echo "Please try to 'new' command to create '${fqdn}'"
        exit 1

    elif ! __is_exist_in_applist; then
        #cat ${applist} | grep ${fqdn} > /dev/null 2>&1
        #if [ $? -ne 0  ]; then
            echo "${project_name}: 'http://${fqdn}' does not exist."
            echo "Please try to 'new' command to create '${fqdn}'"
            exit 1
        #fi

    else
        cd ${app_path}/bin

        # when container removed
        if ! __is_container_exist ${fqdn}-${app_name}; then
            __init && {
                docker-compose -p ${project_name} up -d && {
                    local old=$(cat ${applist} | grep ${fqdn})
                    local new=$(cat ${applist} | grep ${fqdn} | sed -e "s:removed:running:")
                    sed -i -e "s:${old}:${new}:" ${applist}
                }
            }

        # when container running
        elif __is_container_running ${fqdn}-${app_name}; then
            echo ${project_name}: "'http://${fqdn}' is already running"
            exit 1

        # when container stopped
        else
            __init && {
                docker-compose -p ${project_name} start && {
                    local old=$(cat ${applist} | grep ${fqdn})
                    local new=$(cat ${applist} | grep ${fqdn} | sed -e "s:stopped:running:")
                    sed -i -e "s:${old}:${new}:" ${applist}
                }
            }
        fi
    fi
}

function _stop() {
   cd ${app_path}/bin
   docker-compose -p ${project_name} stop && {
       if [ -f ${applist} ]; then
           local old=$(cat ${applist} | grep ${applist_grep_key})
           local new=$(cat ${applist} | grep ${applist_grep_key} | sed -e "s:running:stopped:")
           sed -i -e "s:${old}:${new}:" ${applist}
       else
           echo "error@_stop() in toybox"
       fi
   }
    #if [ ${app_name} = "proxy" ]; then
    #   cd ${app_path}/bin
    #   docker-compose -p ${project_name} stop && {
    #       if [ -f ${applist} ]; then
    #           local old=$(cat ${applist} | grep ${port})
    #           local new=$(cat ${applist} | grep ${port} | sed -e "s:running:stopped:")
    #           sed -i -e "s:${old}:${new}:" ${applist}
    #       else
    #           echo "error@_stop() in toybox"
    #       fi
    #   }
    #else
    #   cd ${app_path}/bin
    #   docker-compose -p ${project_name} stop && {
    #       if [ -f ${applist} ]; then
    #           local old=$(cat ${applist} | grep ${fqdn})
    #           local new=$(cat ${applist} | grep ${fqdn} | sed -e "s:running:stopped:")
    #           sed -i -e "s:${old}:${new}:" ${applist}
    #       else
    #           echo "error@_stop() in toybox"
    #       fi
    #   }
    #fi
}

function _restart() {
    _stop && {
        _rm && {
            _start
        }
    }
}

function _rm() {
    if __is_container_running ${fqdn}-${app_name}; then
        echo ${project_name}: "'http://${fqdn}' is running now."
        echo "Please stop it first.( toybox http://${fqdn} stop )"
        exit 1
    fi

    cd ${app_path}/bin
    echo y | docker-compose -p ${project_name} rm && {
        if [ -f ${applist} ]; then
            old=$(cat ${applist} | grep ${fqdn})
            new=$(cat ${applist} | grep ${fqdn} | sed -e "s:stopped:removed:")
            sed -i -e "s:${old}:${new}:" ${applist}
            #sed -i -e "/${fqdn}/d" ${applist}
        else
            echo "error@_rm() in toybox"
        fi
    }
}

function _clear() {
    if __is_container_running ${fqdn}-${app_name}; then
        echo ${project_name}: "'http://${fqdn}' is running now."
        echo "Please stop and remove it first.( toybox http://${fqdn} stop )"
        exit 1
    fi
    if __is_container_exist ${fqdn}-${app_name}; then
        echo ${project_name}: "'http://${fqdn}' is existing now."
        echo "Please remove t first.( toybox http://${fqdn} rm )"
        exit 1
    fi

    sed -i -e "/${fqdn}/d" ${applist}
    sudo rm -rf ${app_path}
}


function _logs() {
    cd ${app_path}/bin
    docker-compose -p ${project_name} logs
}

function _ps() {
    cd ${app_path}/bin
    docker-compose -p ${project_name} ps
}

function _ip() {
    for container in ${containers[@]}; do
        #__is_container_exist ${fqdn}-${app_name}; local exist=$(( ${exist} + $? ))
        #__is_container_running ${fqdn}-${app_name}; local running=$(( ${running} + $? ))
        __is_container_exist ${container}; local exist=$(( ${exist} + $? ))
        __is_container_running ${container}; local running=$(( ${running} + $? ))
        if [ ${exist} -eq 0 ] && [ ${running} -eq 0 ]; then
            echo -n "${container}: "
            docker inspect -f '{{ .NetworkSettings.IPAddress }}' \
                $(docker ps | grep ${container}_1 | awk '{print $1}')
        else
            echo -n "${container}(not running)"
        fi
    done
}

# ----------------------------------------
# Main Function
# ----------------------------------------

function __docker_toybox() {
    # Load application module
    if [ -e $TOYBOX_HOME/lib/${app_name}.fnc ]; then
        . $TOYBOX_HOME/lib/${app_name}.fnc
        mkdir -p ${app_path}
    else
        echo "${project_name}: No such application as '${app_name}'"
        exit 1
    fi
    
    # Exec Command
    local command=$1
    if __is_executable "_${command}" ; then
        _${command} $@
    else
        echo "${project_name}: '${command}' is not a ${project_name} command." 
        echo "See '${project_name} -h'." 
        exit 1
    fi
}

# ----------------------------------------
# Main Routine
# ----------------------------------------

# check components
__is_executable docker || {
    cat <<EOF
toybox: "docker" command is required.
See: https://docs.docker.com/installation/#installation
EOF
    exit 1
  }

__is_executable docker-compose || {
    cat <<EOF
toybox: "docker-compose" command is required.
See: https://docs.docker.com/compose/install/
EOF
    exit 1
  }

__is_set_env TOYBOX_HOME || {
    cat <<EOF
toybox: enviroment variable "TOYBOX_HOME" is not set. 
Please set it for your absolute path of the docker-toybox installed directory
e.g. export TOYBOX_HOME=/home/nobita/workspace/docker-toybox
EOF
    exit 1
}

#__is_set_env TOYBOX_LETSENCRYPT_HOST || {
#    cat <<EOF
#toybox: "TOYBOX_LETSENCRYPT_HOST" is not set. 
#Please set it if you want to use SSL access with Let's Encrypt certification.
#e.g. export TOYBOX_LETSENCRYPT_HOST=www.example.com
#EOF
#}
#
#__is_set_env TOYBOX_LETSENCRYPT_EMAIL || {
#    cat <<EOF
#toybox: "TOYBOX_LETSENCRYPT_EMAIL" is not set. 
#Please set it if you want to use SSL access with Let's Encrypt certification.
#e.g. export LETSENCRYPT_EMAIL=user@example.com
#EOF
#}

# check options
while getopts s:d: OPT
do
  case $OPT in
    "s" ) sub_domain="${OPTARG}" ;;
    "d" ) domain="${OPTARG}" ;;
  esac
done
shift $(expr $OPTIND - 1)

# check arguments
if [ $# -eq 0 ]; then
    __list

elif [ $# -eq 1 ]; then
    if [ $1 = "reset" ]; then
        echo "Are you sure you want to reset all of containers related ${project_name}?(y/n)"
        read answer
        if [ ${answer} = "y" ]; then
            echo -n 'docker stop...'
            docker stop $(docker ps | grep ${project_name} | awk '{print $1}') > /dev/null 2>&1
            echo 'done.'
            echo -n 'docker rm...'
            docker rm $(docker ps -a | grep ${project_name} | awk '{print $1}') > /dev/null 2>&1
            echo 'done.'
            echo -n 'remove stack directory...'
            sudo rm -rf $TOYBOX_HOME/stack && {
                echo 'done.'
            }
        fi
    elif __is_executable "_$1" ; then
        _$1
    else
        echo "${project_name}: Invalid argument(s)."
        exit 1;
    fi

elif [ $# -eq 2 ]; then

    arg=$1; shift
    
    # ----------------------------------------
    # set variables: URL form
    # ----------------------------------------
    if [[ ${arg} =~ ^http://.* ]]; then
        
        fqdn=$(echo ${arg} | sed "s?http://??")
        applist_grep_key=${fqdn}
    
        if [ ! -f ${applist} ]; then
            echo "${project_name}: No application available."
            echo "Please create application first."
            exit 1
        fi
    
        app_name="$(cat ${applist} | grep ${fqdn} | awk '{print $2}')"
        app_path="$(cat ${applist} | grep ${fqdn} | awk '{print $4}')"
        compose_file="${app_path}/bin/docker-compose.yml"
        src="$TOYBOX_HOME/src/${app_name}"
        
        if [ ! -n "${app_name}" ] && [ ! -n "${app_path}" ]; then
            echo "${project_name}: 'http://${fqdn}' may be invalid URL."
            exit 1
        fi
    
    # ----------------------------------------
    # set variables: Generic Form
    # ----------------------------------------
    elif [ ${arg} = "proxy" ]; then
        port=80
        applist_grep_key=${port}

        app_name=${arg}
        app_path="$TOYBOX_HOME/stack/${app_name}/${port}"
        compose_file="${app_path}/bin/docker-compose.yml"
        src="$TOYBOX_HOME/src/${app_name}"
    else
        app_name=$(echo ${arg} | cut -d":" -f1)
        app_version=$(echo ${arg} | cut -d":" -f2)

        if [ ! -f $TOYBOX_HOME/lib/${app_name}.fnc ]; then
            echo "${project_name}: Invalid argument(s)."
            exit 1;
        fi
    
        # set FQDN
        if [ "${domain}" = '' ]; then
            if [ -z "$TOYBOX_DOMAIN" ] ; then
                domain=docker-toybox.com
            else
                domain=$TOYBOX_DOMAIN
            fi
        fi
        if [ "${sub_domain}" = '' ]; then
            sub_domain=${app_name}
        fi
    
        fqdn="${sub_domain}.${domain}"
        applist_grep_key=${fqdn}

        app_path="$TOYBOX_HOME/stack/${app_name}/${sub_domain}.${domain}"
        compose_file="${app_path}/bin/docker-compose.yml"
        src="$TOYBOX_HOME/src/${app_name}"
       
        if [ $1 != "new" ]; then
            echo ${project_name}": Invalid argument(s)."
            echo "See '${project_name} -h'." 
            exit 1
        fi
    fi

    # ----------------------------------------
    # Exec main command
    # ----------------------------------------
    __docker_toybox $@
else
    echo "${project_name}: Invalid argument(s)."
    exit 1;
fi

exit 0
